<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hangman Game - Online Version</title>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P8271HY3XZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-P8271HY3XZ');
</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#87CEEB;display:flex;flex-direction:column;align-items:center;min-height:100vh;overflow-x:hidden;}
  .container{max-width:900px;width:95%;padding:20px;text-align:center;}
  .hangman-stage{max-width:500px;width:90%;margin:20px auto;display:block;}
  .word-display{display:flex;justify-content:center;flex-wrap:wrap;gap:6px;margin:20px 0;}
  .word-slot{position:relative;width:50px;height:50px;display:inline-block;margin:0 4px;}
  .word-slot img.platform{width:100%;height:100%;}
  .word-slot img.letter{position:absolute;top:0;left:0;width:100%;height:100%;}
  .alphabet{display:flex;flex-wrap:wrap;justify-content:center;gap:12px;margin-top:20px;}
  .alphabet img{width:50px;height:50px;cursor:pointer;transition:transform 0.2s, filter 0.2s;}
  .alphabet img:hover{transform:scale(1.1);filter:brightness(1.2);}
  .alphabet img.disabled{opacity:0.4;cursor:not-allowed;}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff;font-size:2rem;gap:20px;z-index:10;display:none;}
  .overlay button{padding:12px 28px;font-size:1rem;cursor:pointer;border:none;border-radius:8px;background:#ffd166;color:#000;font-weight:700;transition:transform 0.2s;}
  .overlay button:hover{transform:scale(1.05);}
  #turnsContainer {position: fixed; top: 200px; right: 5px; z-index: 20; text-align: center;}
  #turnsContainer img {max-width: 100px; width: 100%; height: auto;}
  #hint {margin-top: 10px; font-size: 1.2rem; color: #222; font-weight: 500;}
  .online-status {position: fixed; top: 10px; right: 10px; padding: 8px 12px; border-radius: 4px; font-size: 0.9em; z-index: 30;}
  .online {background: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
  .offline {background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
  .leaderboard {background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 20px 0; max-height: 300px; overflow-y: auto;}
  .leaderboard h3 {color: #fff; margin-bottom: 10px;}
  .leaderboard ul {list-style: none; padding: 0;}
  .leaderboard li {background: rgba(255,255,255,0.1); margin: 5px 0; padding: 8px 12px; border-radius: 4px; color: #fff;}
  .loading {color: #ffa726; text-align: center; padding: 10px;}
  .error {color: #ff6b6b; text-align: center; padding: 10px;}
</style>
</head>
<body>

<!-- Online Status Indicator -->
<div id="onlineStatus" class="online-status online">üåê Online</div>

<!-- Audio -->
<audio id="hoverSound" src="assets/sounds/hover.mp3"></audio>
<audio id="clickSound" src="assets/sounds/click.mp3"></audio>
<audio id="winSound" src="assets/sounds/correct.mp3"></audio>
<audio id="loseSound" src="assets/sounds/wrong.mp3"></audio>

<!-- Turns left -->
<div id="turnsContainer">
  <img src="assets/turns_6.png" alt="Turns Left" id="turnsLeft">
</div>

<div class="container">
  <img src="assets/stage01.png" alt="Hangman Stage" class="hangman-stage" id="hangmanStage">
  <div class="word-display" id="wordDisplay"></div>
  <div id="hint"></div>
  <div class="alphabet" id="alphabet"></div>
</div>

<div class="overlay" id="gameOverlay">
  <div id="overlayMessage"></div>
  <div class="leaderboard">
    <h3>üèÜ Global Leaderboard</h3>
    <ul id="leaderboardList">
      <li class="loading">Loading leaderboard...</li>
    </ul>
  </div>
  <button id="restartBtn">Play Again</button>
</div>

<script type="module">
// Import Firebase functions
import { addScore, getTopScores } from './firebase-leaderboard.js';

let selectedWord = "";
let selectedHint = "";
let guessedLetters = [];
let mistakes = 0;
const maxMistakes = 6;

// Get grade & subject from localStorage or use defaults
const grade = localStorage.getItem("selectedGrade") || "1";
const subject = localStorage.getItem("selectedSubject") || "english";

// Word lists by subject and grade
const wordBank = {
  "english": {
    "1": [
      {word:"CAT", hint:"A pet animal"},
      {word:"DOG", hint:"Man's best friend"},
      {word:"SUN", hint:"Bright in sky"},
      {word:"MOON", hint:"Shines at night"}
    ],
    "2": [
      {word:"HOUSE", hint:"Where we live"},
      {word:"TREE", hint:"Tall plant"},
      {word:"WATER", hint:"Clear liquid"},
      {word:"BREAD", hint:"Food we eat"}
    ],
    "3": [
      {word:"SCHOOL", hint:"Place to learn"},
      {word:"FRIEND", hint:"Someone you like"},
      {word:"FAMILY", hint:"Your relatives"},
      {word:"HAPPY", hint:"Feeling good"}
    ],
    "4": [
      {word:"ELEPHANT", hint:"Large animal with trunk"},
      {word:"BUTTERFLY", hint:"Colorful flying insect"},
      {word:"RAINBOW", hint:"Colorful arc in sky"},
      {word:"ADVENTURE", hint:"Exciting journey"}
    ],
    "5": [
      {word:"COMPUTER", hint:"Electronic device"},
      {word:"JOURNEY", hint:"Long trip"},
      {word:"KNOWLEDGE", hint:"What you learn"},
      {word:"CHALLENGE", hint:"Difficult task"}
    ],
    "6": [
      {word:"IMAGINATION", hint:"Creative thinking"},
      {word:"PHILOSOPHY", hint:"Study of ideas"},
      {word:"LITERATURE", hint:"Written works"},
      {word:"GRAMMAR", hint:"Language rules"}
    ]
  },
  "science": {
    "1": [
      {word:"SUN", hint:"Gives us light"},
      {word:"TREE", hint:"Plant with leaves"},
      {word:"WATER", hint:"Clear liquid"},
      {word:"ROCK", hint:"Hard stone"}
    ],
    "2": [
      {word:"PLANT", hint:"Grows in soil"},
      {word:"ANIMAL", hint:"Living creature"},
      {word:"EARTH", hint:"Our planet"},
      {word:"WIND", hint:"Moving air"}
    ],
    "3": [
      {word:"ENERGY", hint:"Power source"},
      {word:"GRAVITY", hint:"Pulls things down"},
      {word:"MATTER", hint:"Everything around us"},
      {word:"FORCE", hint:"Push or pull"}
    ],
    "4": [
      {word:"ATOM", hint:"Smallest unit of matter"},
      {word:"MOLECULE", hint:"Group of atoms"},
      {word:"ECOSYSTEM", hint:"Living community"},
      {word:"EVOLUTION", hint:"Change over time"}
    ],
    "5": [
      {word:"PHOTOSYNTHESIS", hint:"How plants make food"},
      {word:"MAGNETISM", hint:"Attraction force"},
      {word:"ELECTRICITY", hint:"Electrical energy"},
      {word:"CHEMISTRY", hint:"Study of matter"}
    ],
    "6": [
      {word:"BIOTECHNOLOGY", hint:"Using living things"},
      {word:"ASTROPHYSICS", hint:"Physics of space"},
      {word:"NEUROSCIENCE", hint:"Study of brain"},
      {word:"GENETICS", hint:"Study of heredity"}
    ]
  },
  "social": {
    "1": [
      {word:"HOME", hint:"Where you live"},
      {word:"FAMILY", hint:"Your relatives"},
      {word:"FRIEND", hint:"Someone you like"},
      {word:"SCHOOL", hint:"Place to learn"}
    ],
    "2": [
      {word:"CITY", hint:"Large town"},
      {word:"COUNTRY", hint:"A nation"},
      {word:"FLAG", hint:"National symbol"},
      {word:"CULTURE", hint:"Way of life"}
    ],
    "3": [
      {word:"GOVERNMENT", hint:"Ruling system"},
      {word:"DEMOCRACY", hint:"People's rule"},
      {word:"HISTORY", hint:"Past events"},
      {word:"LEADER", hint:"Person in charge"}
    ],
    "4": [
      {word:"CIVILIZATION", hint:"Advanced society"},
      {word:"REVOLUTION", hint:"Major change"},
      {word:"CONSTITUTION", hint:"Basic laws"},
      {word:"INDEPENDENCE", hint:"Being free"}
    ],
    "5": [
      {word:"GEOGRAPHY", hint:"Study of Earth"},
      {word:"ECONOMICS", hint:"Study of money"},
      {word:"SOCIOLOGY", hint:"Study of society"},
      {word:"ANTHROPOLOGY", hint:"Study of humans"}
    ],
    "6": [
      {word:"PHILOSOPHY", hint:"Study of ideas"},
      {word:"POLITICS", hint:"Government affairs"},
      {word:"INTERNATIONAL", hint:"Between countries"},
      {word:"GLOBALIZATION", hint:"Worldwide connection"}
    ]
  },
  "computer": {
    "1": [
      {word:"MOUSE", hint:"Computer pointer"},
      {word:"KEY", hint:"Button to press"},
      {word:"SCREEN", hint:"What you look at"},
      {word:"GAME", hint:"Fun activity"}
    ],
    "2": [
      {word:"KEYBOARD", hint:"Input device"},
      {word:"MONITOR", hint:"Display screen"},
      {word:"CURSOR", hint:"Moving pointer"},
      {word:"MENU", hint:"List of options"}
    ],
    "3": [
      {word:"PROGRAM", hint:"Set of instructions"},
      {word:"SOFTWARE", hint:"Computer programs"},
      {word:"HARDWARE", hint:"Physical parts"},
      {word:"INTERNET", hint:"World wide web"}
    ],
    "4": [
      {word:"ALGORITHM", hint:"Step by step solution"},
      {word:"DATABASE", hint:"Stores information"},
      {word:"NETWORK", hint:"Connected computers"},
      {word:"SECURITY", hint:"Protection system"}
    ],
    "5": [
      {word:"PROGRAMMING", hint:"Writing code"},
      {word:"JAVASCRIPT", hint:"Programming language"},
      {word:"FUNCTION", hint:"Reusable code block"},
      {word:"VARIABLE", hint:"Stores data"}
    ],
    "6": [
      {word:"ARTIFICIAL", hint:"Made by humans"},
      {word:"INTELLIGENCE", hint:"Smart thinking"},
      {word:"MACHINE", hint:"Mechanical device"},
      {word:"LEARNING", hint:"Gaining knowledge"}
    ]
  },
  "gk": {
    "1": [
      {word:"EARTH", hint:"Our planet"},
      {word:"MOON", hint:"Shines at night"},
      {word:"STAR", hint:"Bright in sky"},
      {word:"OCEAN", hint:"Large water body"}
    ],
    "2": [
      {word:"MOUNTAIN", hint:"High land"},
      {word:"RIVER", hint:"Flows through land"},
      {word:"FOREST", hint:"Many trees"},
      {word:"DESERT", hint:"Dry land"}
    ],
    "3": [
      {word:"CONTINENT", hint:"Large land mass"},
      {word:"COUNTRY", hint:"A nation"},
      {word:"CAPITAL", hint:"Main city"},
      {word:"PRESIDENT", hint:"Leader of country"}
    ],
    "4": [
      {word:"GALAXY", hint:"Collection of stars"},
      {word:"VOLCANO", hint:"Mountain that erupts"},
      {word:"EARTHQUAKE", hint:"Ground shaking"},
      {word:"HURRICANE", hint:"Strong storm"}
    ],
    "5": [
      {word:"UNIVERSE", hint:"Everything that exists"},
      {word:"SATELLITE", hint:"Orbiting object"},
      {word:"TELESCOPE", hint:"See far away"},
      {word:"EXPLORATION", hint:"Discovering new places"}
    ],
    "6": [
      {word:"COSMOLOGY", hint:"Study of universe"},
      {word:"ASTROPHYSICS", hint:"Physics of space"},
      {word:"EXTRATERRESTRIAL", hint:"From outer space"},
      {word:"INTERGALACTIC", hint:"Between galaxies"}
    ]
  },
  "days": {
    "1": [
      {word:"MONDAY", hint:"First day of school"},
      {word:"TUESDAY", hint:"Second day of week"},
      {word:"WEDNESDAY", hint:"Middle of week"},
      {word:"THURSDAY", hint:"Almost weekend"}
    ],
    "2": [
      {word:"FRIDAY", hint:"Last day of school"},
      {word:"SATURDAY", hint:"Weekend fun day"},
      {word:"SUNDAY", hint:"Day of rest"},
      {word:"WEEK", hint:"Seven days together"}
    ],
    "3": [
      {word:"MONDAY", hint:"Start of work week"},
      {word:"TUESDAY", hint:"Second day of work"},
      {word:"WEDNESDAY", hint:"Hump day"},
      {word:"THURSDAY", hint:"Almost Friday"}
    ],
    "4": [
      {word:"FRIDAY", hint:"TGIF day"},
      {word:"SATURDAY", hint:"Weekend begins"},
      {word:"SUNDAY", hint:"Day before Monday"},
      {word:"WEEKEND", hint:"Two days off"}
    ],
    "5": [
      {word:"MONDAY", hint:"Blue Monday"},
      {word:"TUESDAY", hint:"Ruby Tuesday"},
      {word:"WEDNESDAY", hint:"Wednesday's child"},
      {word:"THURSDAY", hint:"Thor's day"}
    ],
    "6": [
      {word:"FRIDAY", hint:"Freaky Friday"},
      {word:"SATURDAY", hint:"Saturday night fever"},
      {word:"SUNDAY", hint:"Sunday best"},
      {word:"WEEKDAY", hint:"Monday to Friday"}
    ]
  },
  "months": {
    "1": [
      {word:"JANUARY", hint:"First month"},
      {word:"FEBRUARY", hint:"Valentine's month"},
      {word:"MARCH", hint:"Spring begins"},
      {word:"APRIL", hint:"April showers"}
    ],
    "2": [
      {word:"MAY", hint:"May flowers"},
      {word:"JUNE", hint:"Summer starts"},
      {word:"JULY", hint:"Independence month"},
      {word:"AUGUST", hint:"Hot summer month"}
    ],
    "3": [
      {word:"SEPTEMBER", hint:"Back to school"},
      {word:"OCTOBER", hint:"Halloween month"},
      {word:"NOVEMBER", hint:"Thanksgiving month"},
      {word:"DECEMBER", hint:"Christmas month"}
    ],
    "4": [
      {word:"JANUARY", hint:"New Year's month"},
      {word:"FEBRUARY", hint:"Shortest month"},
      {word:"MARCH", hint:"Spring equinox"},
      {word:"APRIL", hint:"April Fool's Day"}
    ],
    "5": [
      {word:"MAY", hint:"Mother's Day month"},
      {word:"JUNE", hint:"Father's Day month"},
      {word:"JULY", hint:"Fourth of July"},
      {word:"AUGUST", hint:"Summer vacation"}
    ],
    "6": [
      {word:"SEPTEMBER", hint:"Labor Day month"},
      {word:"OCTOBER", hint:"Autumn colors"},
      {word:"NOVEMBER", hint:"Election month"},
      {word:"DECEMBER", hint:"Winter solstice"}
    ]
  }
};

const hangmanStage = document.getElementById("hangmanStage");
const wordDisplay = document.getElementById("wordDisplay");
const alphabetDiv = document.getElementById("alphabet");
const overlay = document.getElementById("gameOverlay");
const overlayMessage = document.getElementById("overlayMessage");
const restartBtn = document.getElementById("restartBtn");
const turnsLeftImg = document.getElementById("turnsLeft");
const hintDiv = document.getElementById("hint");
const leaderboardList = document.getElementById("leaderboardList");
const onlineStatus = document.getElementById("onlineStatus");

const hoverSound = document.getElementById("hoverSound");
const clickSound = document.getElementById("clickSound");
const winSound = document.getElementById("winSound");
const loseSound = document.getElementById("loseSound");

// Check online status
function updateOnlineStatus() {
  if (navigator.onLine) {
    onlineStatus.textContent = "üåê Online";
    onlineStatus.className = "online-status online";
  } else {
    onlineStatus.textContent = "üì± Offline";
    onlineStatus.className = "online-status offline";
  }
}

// Listen for online/offline events
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Hover sound on letters
alphabetDiv.addEventListener("mouseover", e => {
  if(e.target.tagName === "IMG" && !e.target.classList.contains("disabled")){
    hoverSound.currentTime = 0;
    hoverSound.play();
  }
});

// Init game
function initGame(){
  // Get words for selected subject and grade
  const subjectWords = wordBank[subject];
  if (!subjectWords) {
    console.error(`Subject ${subject} not found, using English`);
    const selection = wordBank["english"]["1"][0];
    selectedWord = selection.word;
    selectedHint = selection.hint;
  } else {
    const gradeWords = subjectWords[grade];
    if (!gradeWords || gradeWords.length === 0) {
      console.error(`Grade ${grade} not found for ${subject}, using grade 1`);
      const selection = subjectWords["1"][0];
      selectedWord = selection.word;
      selectedHint = selection.hint;
    } else {
      const randomIndex = Math.floor(Math.random() * gradeWords.length);
      const selection = gradeWords[randomIndex];
      selectedWord = selection.word;
      selectedHint = selection.hint;
    }
  }

  guessedLetters = [];
  mistakes = 0;
  hangmanStage.src = `assets/stage01.png`;
  overlay.style.display = "none";
  updateTurnsLeft();
  displayWord();
  createAlphabet();
  hintDiv.textContent = "Hint: " + selectedHint;
  loadLeaderboard();
}

// Display word
function displayWord(){
  wordDisplay.innerHTML = "";
  for(let letter of selectedWord){
    const slot = document.createElement("div");
    slot.className = "word-slot";

    const platformImg = document.createElement("img");
    platformImg.src = "assets/platform_blank.png";
    platformImg.alt = "_";
    platformImg.className = "platform";
    slot.appendChild(platformImg);

    if(guessedLetters.includes(letter)){
      const letterImg = document.createElement("img");
      letterImg.src = `assets/platform_letter_${letter}.jpg`;
      letterImg.alt = letter;
      letterImg.className = "letter";
      slot.appendChild(letterImg);
    }

    wordDisplay.appendChild(slot);
  }
}

// Create alphabet
function createAlphabet(){
  alphabetDiv.innerHTML = "";
  for(let i=65;i<=90;i++){
    const letter = String.fromCharCode(i);
    const img = document.createElement("img");
    img.src = `assets/letters/${letter}.jpg`;
    img.alt = letter;

    img.addEventListener("click", ()=> handleGuess(letter,img));
    alphabetDiv.appendChild(img);
  }
}

// Update turns left
function updateTurnsLeft(){
  const remainingTurns = Math.max(maxMistakes - mistakes, 0);
  turnsLeftImg.src = `assets/turns_${remainingTurns}.png`;
}

// Handle guess
function handleGuess(letter,img){
  if(guessedLetters.includes(letter) || img.classList.contains("disabled")) return;
  guessedLetters.push(letter);
  img.classList.add("disabled");

  clickSound.currentTime = 0;
  clickSound.play();

  if(selectedWord.includes(letter)){
    displayWord();
    checkWin();
  } else {
    mistakes++;
    hangmanStage.src = `assets/stage0${mistakes+1}.png`;
    updateTurnsLeft();
    if(mistakes >= maxMistakes) showOverlay(false);
  }
}

// Check win
function checkWin(){
  const wordGuessed = selectedWord.split("").every(l => guessedLetters.includes(l));
  if(wordGuessed) showOverlay(true);
}

// Show overlay + leaderboard
function showOverlay(win){
  overlay.style.display = "flex";
  overlayMessage.textContent = win ? "You Won! üéâ" : `You Lost üò¢\nWord: ${selectedWord}`;

  if(win) {
    let playerName = prompt("Enter your name for leaderboard:") || "Anonymous";
    const score = maxMistakes - mistakes; // Higher score = fewer mistakes
    addScoreToLeaderboard(playerName, score);
  }

  if(win) winSound.play(); else loseSound.play();
  loadLeaderboard(); // Refresh leaderboard display
}

// Add score to Firebase leaderboard
async function addScoreToLeaderboard(name, score) {
  try {
    console.log("Adding score to Firebase:", { name, score });
    
    // Track game completion in Google Analytics
    if (typeof gtag !== 'undefined') {
      gtag('event', 'game_completed', {
        'event_category': 'game',
        'event_label': 'hangman_win',
        'value': score
      });
    }
    
    const success = await addScore(name, score);
    if (success) {
      console.log("‚úÖ Score added to Firebase successfully!");
      
      // Track score submission in Google Analytics
      if (typeof gtag !== 'undefined') {
        gtag('event', 'score_submitted', {
          'event_category': 'leaderboard',
          'event_label': 'firebase_save',
          'value': score
        });
      }
      
      // Show success message briefly
      const originalText = overlayMessage.textContent;
      overlayMessage.textContent = "Score saved! üéâ";
      setTimeout(() => {
        overlayMessage.textContent = originalText;
      }, 2000);
    } else {
      console.error("‚ùå Failed to add score to Firebase");
      overlayMessage.textContent += "\n‚ö†Ô∏è Score not saved (offline)";
    }
  } catch (error) {
    console.error("Error adding score to Firebase:", error);
    overlayMessage.textContent += "\n‚ö†Ô∏è Score not saved (error)";
  }
}

// Load and display Firebase leaderboard
async function loadLeaderboard() {
  try {
    console.log("Loading leaderboard from Firebase...");
    leaderboardList.innerHTML = "<li class='loading'>Loading leaderboard...</li>";
    
    const scores = await getTopScores(10);
    console.log("Scores received from Firebase:", scores);
    
    leaderboardList.innerHTML = "";
    
    if (scores.length === 0) {
      leaderboardList.innerHTML = "<li class='loading'>No scores yet - Be the first to play!</li>";
      return;
    }
    
    scores.forEach((score, index) => {
      const li = document.createElement("li");
      li.style.margin = "5px 0";
      li.style.padding = "8px 12px";
      li.style.backgroundColor = "rgba(255,255,255,0.1)";
      li.style.borderRadius = "4px";
      
      // Add ranking emoji
      let rankEmoji = "ü•â";
      if (index === 0) rankEmoji = "ü•á";
      else if (index === 1) rankEmoji = "ü•à";
      else if (index === 2) rankEmoji = "ü•â";
      
      li.innerHTML = `
        <strong>${rankEmoji} ${index + 1}.</strong> ${score.name} - ${score.score} points
        <small style="color: #ccc; display: block; font-size: 0.8em;">
          ${new Date(score.timestamp).toLocaleDateString()}
        </small>
      `;
      leaderboardList.appendChild(li);
    });
    
    console.log("‚úÖ Leaderboard displayed successfully");
  } catch (error) {
    console.error("‚ùå Error loading leaderboard:", error);
    leaderboardList.innerHTML = `
      <li class="error">
        ‚ö†Ô∏è Error loading leaderboard<br>
        <small>${error.message}</small>
      </li>
    `;
  }
}

restartBtn.addEventListener("click", initGame);

// Initialize online status and start game
updateOnlineStatus();
document.addEventListener('DOMContentLoaded', initGame);
</script>
</body>
</html>
